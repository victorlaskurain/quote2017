#!/bin/bash

set -e

USER=root
PASSWORD=root
DUMP1=presupuestos2000_current.sql
DUMP2=presupuestos2000_recovered.sql
DB1=presupuestos_db1
DB2=presupuestos_db2
DBCOMBINED=presupuestos_combined
mysql -u$USER -p$PASSWORD <<EOF
DROP DATABASE IF EXISTS $DB1;
CREATE DATABASE $DB1;
DROP DATABASE IF EXISTS $DB2;
CREATE DATABASE $DB2;
DROP DATABASE IF EXISTS $DBCOMBINED;
CREATE DATABASE $DBCOMBINED;
USE $DBCOMBINED;
CREATE TABLE bezeroa (
  BEZZENB int(11) NOT NULL DEFAULT 0,
  BEZIZEN varchar(100) NOT NULL DEFAULT '',
  PRIMARY KEY (BEZZENB)
) ENGINE=MyISAM DEFAULT CHARSET=latin1;
CREATE TABLE presupuestoa (
  ONARTUA tinyint(1) NOT NULL DEFAULT 0,
  PRESZENB int(11) NOT NULL AUTO_INCREMENT,
  BEZZENB int(11) NOT NULL DEFAULT 0,
  TALADROA decimal(10,3) NOT NULL DEFAULT 0.000,
  TORNUA decimal(10,3) NOT NULL DEFAULT 0.000,
  DESKRIBAPENA varchar(255) CHARACTER SET latin1 NOT NULL DEFAULT '""',
  GARRAIOAK decimal(10,3) NOT NULL DEFAULT 0.000,
  FORJA decimal(10,3) NOT NULL DEFAULT 0.000,
  ZERRA decimal(10,3) NOT NULL DEFAULT 0.000,
  EGUNEKOZENB int(11) NOT NULL DEFAULT 0,
  BEST1 varchar(255) CHARACTER SET latin1 NOT NULL DEFAULT '',
  BEST2 varchar(255) CHARACTER SET latin1 NOT NULL DEFAULT '',
  BEST3 varchar(255) CHARACTER SET latin1 NOT NULL DEFAULT '',
  PREZ1 decimal(10,3) NOT NULL DEFAULT 0.000,
  PREZ2 decimal(10,3) NOT NULL DEFAULT 0.000,
  PREZ3 decimal(10,3) NOT NULL DEFAULT 0.000,
  BIGUNK decimal(10,3) NOT NULL DEFAULT 0.000,
  CEMENT decimal(10,3) NOT NULL DEFAULT 0.000,
  DATA date NOT NULL DEFAULT '0000-00-00',
  PISUA decimal(10,3) NOT NULL DEFAULT 0.000,
  PREZIOA decimal(10,3) NOT NULL DEFAULT 0.000,
  TENPLEA decimal(10,3) NOT NULL DEFAULT 0.000,
  FRESA decimal(10,3) NOT NULL DEFAULT 0.000,
  HARIA decimal(10,3) NOT NULL DEFAULT 0.000,
  KOMISIOAK decimal(10,3) NOT NULL DEFAULT 0.000,
  ARTEZKETA decimal(10,3) NOT NULL DEFAULT 0.000,
  PRIMARY KEY (PRESZENB)
) ENGINE=MyISAM AUTO_INCREMENT=12541 DEFAULT CHARSET=latin1 COLLATE=latin1_spanish_ci;
EOF

mysql -u$USER -p$PASSWORD $DB1 < $DUMP1
mysql -u$USER -p$PASSWORD $DB2 < $DUMP2
mysql -u$USER -p$PASSWORD <<EOF
INSERT INTO $DBCOMBINED.bezeroa (BEZZENB, BEZIZEN)
SELECT BEZZENB,
       BEZIZEN
FROM $DB1.bezeroa
UNION DISTINCT
SELECT BEZZENB,
       BEZIZEN
FROM $DB2.bezeroa;
INSERT INTO $DBCOMBINED.presupuestoa (
    BEZZENB,
    DATA,
    DESKRIBAPENA,
    GARRAIOAK,
    EGUNEKOZENB,
    ONARTUA,
    TALADROA,
    TORNUA,
    FORJA,
    ZERRA,
    BIGUNK,
    CEMENT,
    PISUA,
    PREZIOA,
    FRESA,
    HARIA,
    KOMISIOAK,
    TENPLEA,
    ARTEZKETA,
    BEST1,
    PREZ1,
    BEST2,
    PREZ2,
    BEST3,
    PREZ3
)
SELECT BEZZENB,
       DATA,
       DESKRIBAPENA,
       GARRAIOAK,
       EGUNEKOZENB,
       ONARTUA,
       TALADROA,
       TORNUA,
       FORJA,
       ZERRA,
       BIGUNK,
       CEMENT,
       PISUA,
       PREZIOA,
       FRESA,
       HARIA,
       KOMISIOAK,
       TENPLEA,
       ARTEZKETA,
       BEST1,
       PREZ1,
       BEST2,
       PREZ2,
       BEST3,
       PREZ3
FROM $DB1.presupuestoa
UNION DISTINCT
SELECT BEZZENB,
       DATA,
       DESKRIBAPENA,
       GARRAIOAK,
       EGUNEKOZENB,
       ONARTUA,
       TALADROA,
       TORNUA,
       FORJA,
       ZERRA,
       BIGUNK,
       CEMENT,
       PISUA,
       PREZIOA,
       FRESA,
       HARIA,
       KOMISIOAK,
       TENPLEA,
       ARTEZKETA,
       BEST1,
       PREZ1,
       BEST2,
       PREZ2,
       BEST3,
       PREZ3
FROM $DB2.presupuestoa;
EOF
